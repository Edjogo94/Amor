<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Para Mi Amada Reina E.G.</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Parisienne&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* Fuentes personalizadas */
        .font-parisienne { font-family: 'Parisienne', cursive; }
        .font-playfair { font-family: 'Playfair Display', serif; }

        /* Efecto de corazón latiendo */
        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }
        .heartbeat { animation: heartbeat 1.5s ease-in-out infinite; }
        
        /* Ocultar barra de scroll por defecto */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #9ca3af; }

        /* Estilos para el botón de subir archivo */
        input[type="file"] { display: none; }
        .file-upload-label {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            background-color: #3b82f6; /* bg-blue-500 */
            color: white;
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem; /* rounded-lg */
            font-weight: 700; /* font-bold */
            transition: background-color 0.3s;
        }
        .file-upload-label:hover {
            background-color: #2563eb; /* bg-blue-600 */
        }
        .file-upload-label svg {
            margin-right: 0.5rem;
        }
    </style>
</head>
<body class="bg-gray-100 font-playfair text-gray-800">

    <!-- Wrapper -->
    <div class="container mx-auto max-w-4xl p-4 sm:p-8">

        <!-- 1. Sección de Encabezado (Foto 1) -->
        <header class="relative h-96 w-full rounded-2xl overflow-hidden shadow-2xl mb-12">
            <!-- Imagen de fondo -->
            <div class="absolute inset-0 bg-center bg-cover" style="background-image: url('foto1.jpg');"></div>
            <!-- Capa oscura -->
            <div class="absolute inset-0 bg-black bg-opacity-40"></div>
            <!-- Contenido de texto -->
            <div class="absolute inset-0 flex flex-col items-center justify-center text-center p-4">
                <h1 class="font-parisienne text-white text-6xl sm:text-7xl md:text-8xl" style="text-shadow: 2px 2px 8px rgba(0,0,0,0.7);">
                    Para mi Reina
                </h1>
                <p class="text-white text-xl sm:text-2xl md:text-3xl mt-4 font-playfair" style="text-shadow: 1px 1px 4px rgba(0,0,0,0.7);">
                    Mi corazón es tuyo para siempre
                </p>
            </div>
        </header>

        <!-- 2. Sección Tu Esencia Pura (Foto 2) -->
        <section class="mb-12 bg-white p-6 sm:p-10 rounded-2xl shadow-xl flex flex-col md:flex-row items-center gap-6 sm:gap-10">
            <!-- Texto -->
            <div class="flex-1">
                <h2 class="font-parisienne text-5xl text-rose-500 mb-6 text-center md:text-left">Tu Esencia Pura</h2>
                <div class="space-y-4 text-lg text-gray-700">
                    <div class="flex items-start gap-3">
                        <span class="text-rose-400 text-2xl mt-1">&#10084;</span>
                        <p>Me enamora tu hermosa <strong class="font-bold">personalidad</strong> y tu <strong class="font-bold">sencillez</strong>, que brillan de una forma genuina.</p>
                    </div>
                    <div class="flex items-start gap-3">
                        <span class="text-rose-400 text-xl font-bold mt-1">JW</span>
                        <p>Tu profundo <strong class="font-bold">amor por Jehová</strong>, que es el pilar que guía tu vida y nuestra relación.</p>
                    </div>
                </div>
            </div>
            <!-- Imagen -->
            <div class="w-full md:w-1/3 h-64 md:h-auto md:aspect-square rounded-2xl overflow-hidden shadow-lg bg-gray-200 bg-cover bg-center" style="background-image: url('foto2.jpg');">
            </div>
        </section>

        <!-- 3. Sección Tu Cariño (Foto 3) -->
        <section class="mb-12 bg-white p-6 sm:p-10 rounded-2xl shadow-xl flex flex-col md:flex-row-reverse items-center gap-6 sm:gap-10">
            <!-- Texto -->
            <div class="flex-1">
                <h2 class="font-parisienne text-5xl text-rose-500 mb-6 text-center md:text-left">Tu Cariño</h2>
                <div class="space-y-4 text-lg text-gray-700">
                    <div class="flex items-start gap-3">
                        <span class="text-rose-400 text-2xl mt-1">&#10084;</span>
                        <p>Tu <strong class="font-bold">feminidad</strong> y tu exquisito <strong class="font-bold">trato</strong> lleno de cariño.</p>
                    </div>
                    <div class="flex items-start gap-3">
                        <span class="text-rose-400 text-2xl mt-1">&#10084;</span>
                        <p>Eres tan <strong class="font-bold">cariñosa</strong>, <strong class="font-bold">atenta</strong> y <strong class="font-bold">detallista</strong>, me haces sentir el hombre más afortunado.</p>
                    </div>
                </div>
            </div>
            <!-- Imagen -->
            <div class="w-full md:w-1/3 h-64 md:h-auto md:aspect-square rounded-2xl overflow-hidden shadow-lg bg-gray-200 bg-cover bg-center" style="background-image: url('foto3.jpg');">
            </div>
        </section>

        <!-- 4. Sección Eres Hermosa (Foto 5) -->
        <section class="relative h-96 w-full rounded-2xl overflow-hidden shadow-2xl mb-12">
            <!-- Imagen de fondo -->
            <div class="absolute inset-0 bg-center bg-cover" style="background-image: url('foto5.jpg');"></div>
            <!-- Capa oscura -->
            <div class="absolute inset-0 bg-black bg-opacity-40"></div>
            <!-- Contenido de texto -->
            <div class="absolute inset-0 flex items-center justify-center p-4">
                <h2 class="font-parisienne text-white text-6xl sm:text-7xl md:text-8xl" style="text-shadow: 2px 2px 8px rgba(0,0,0,0.7);">
                    Eres Hermosa
                </h2>
            </div>
        </section>

        <!-- 5. Sección Nuestro Futuro -->
        <section class="mb-12 text-center bg-white p-6 sm:p-10 rounded-2xl shadow-xl">
            <h2 class="font-parisienne text-5xl text-rose-500 mb-6">Nuestro Futuro</h2>
            <p class="text-lg md:text-xl text-gray-700 max-w-2xl mx-auto">
                No concibo una vida sin ti. Mi único deseo es pasar el <strong class="font-bold">resto de mi vida a tu lado</strong>, formando una hermosa familia, sirviendo juntos a Jehová y a nuestros hermanos.
            </I>
        </section>

        <!-- 6. Sección de Cartas y IA -->
        <section class="mb-12 text-center">
            <h2 class="font-parisienne text-5xl text-rose-500 mb-8">Nuestro Tesoro Compartido</h2>
            <div class="flex flex-col sm:flex-row justify-center gap-4">
                <!-- Botón Carta 1 -->
                <button id="openLetterModal" class="flex-1 bg-rose-400 hover:bg-rose-500 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition duration-300">
                    Abrir Primera Carta
                </button>
                <!-- Botón Carta 2 -->
                <button id="openLetterModal2" class="flex-1 bg-rose-400 hover:bg-rose-500 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition duration-300">
                    Abrir Segunda Carta
                </button>
                <!-- Botón IA -->
                <button id="openAiModal" class="flex-1 bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition duration-300 flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9.504 1.132a1 1 0 01.992 0l1.75 1.01a1 1 0 01.5.866v2.02c0 .414.254.785.64.93L15 6.45V5a1 1 0 011-1h2a1 1 0 011 1v1.45l1.614.493c.386.145.64.516.64.93v2.02a1 1 0 01-.5.866l-1.75 1.01a1 1 0 01-.992 0l-1.75-1.01a1 1 0 01-.5-.866V8.02c0-.414-.254-.785-.64-.93L15 6.59V8a1 1 0 01-1 1H8a1 1 0 01-1-1v-1.41l-1.614.493c-.386.145-.64.516-.64.93v2.02a1 1 0 01-.5.866l-1.75 1.01a1 1 0 01-.992 0L.75 11.98a1 1 0 01-.5-.866V9.094c0-.414.254-.785.64-.93L2.5 7.67V9a1 1 0 011 1h2a1 1 0 011-1V7.55l1.614-.493c.386-.145.64-.516.64-.93V4.094a1 1 0 01.5-.866l1.75-1.01zM10 12a1 1 0 011 1v1.45l1.614.493c.386.145.64.516.64.93v2.02a1 1 0 01-.5.866l-1.75 1.01a1 1 0 01-.992 0l-1.75-1.01a1 1 0 01-.5-.866v-2.02c0-.414.254-.785.64-.93L9 14.45V13a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                    Estudio Fotográfico IA
                </button>
            </div>
        </section>

        <!-- 7. Pie de Página (Foto 4) -->
        <footer class="relative h-64 w-full rounded-2xl overflow-hidden shadow-2xl mt-12">
            <!-- Imagen de fondo (MODIFICADA para bg-contain) -->
            <div class="absolute inset-0 bg-center bg-no-repeat bg-contain" style="background-image: url('foto4.jpg'); background-color: #37282C;"></div>
            <!-- Capa oscura -->
            <div class="absolute inset-0 bg-black bg-opacity-30"></div>
             <!-- Contenido de texto -->
            <div class="absolute inset-0 flex flex-col items-center justify-center text-center p-4">
                <div class="heartbeat text-rose-300 text-6xl" style="text-shadow: 0 0 15px #f43f5e;">
                    &#10084;
                </div>
                <!-- Firma con Iniciales -->
                <p class="font-parisienne text-white text-5xl mt-4" style="text-shadow: 2px 2px 8px rgba(0,0,0,0.7);">
                    E.G.
                </p>
            </div>
        </footer>

    </div> <!-- Fin del Wrapper -->


    <!-- =================================================================== -->
    <!-- MODALES (Ocultos por defecto con 'display: none') -->
    <!-- =================================================================== -->

    <!-- Modal 1: Primera Carta -->
    <div id="letterModal" style="display: none;" class="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4">
        <!-- Contenedor del Modal -->
        <div class="bg-white rounded-2xl p-6 max-w-lg w-full shadow-2xl relative">
            <!-- Botón de Cerrar -->
            <button id="closeLetterModal" class="absolute top-3 right-3 text-gray-500 hover:text-gray-900 text-2xl">&times;</button>
            
            <h3 class="text-3xl font-bold text-rose-title mb-4 font-parisienne text-center">La Carta de Mi Reina</h3>
            
            <!-- CONTENIDO DE LA CARTA (Aquí el usuario debe pegar el texto o un <img> de la carta escaneada) -->
            <div id="letterContent" class="bg-yellow-50 p-4 rounded-lg border border-yellow-200 text-gray-700 max-h-96 overflow-y-auto custom-scrollbar">
                
                <!-- Este es el código correcto para mostrar la imagen y la firma -->
                <img src="carta.jpg" alt="Carta de mi Reina" class="w-full h-auto rounded-lg">
                <p class="text-right mt-6 font-semibold">- Tu Reina</p>

            </div>
        </div>
    </div>

    <!-- Modal 2: Segunda Carta -->
    <div id="letterModal2" style="display: none;" class="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4">
        <!-- Contenedor del Modal -->
        <div class="bg-white rounded-2xl p-6 max-w-lg w-full shadow-2xl relative">
            <!-- Botón de Cerrar -->
            <button id="closeLetterModal2" class="absolute top-3 right-3 text-gray-500 hover:text-gray-900 text-2xl">&times;</button>
            
            <h3 class="text-3xl font-bold text-rose-title mb-4 font-parisienne text-center">Nuestra Segunda Carta</h3>
            
            <!-- CONTENIDO DE LA CARTA 2 -->
            <div id="letterContent2" class="bg-yellow-50 p-4 rounded-lg border border-yellow-200 text-gray-700 max-h-96 overflow-y-auto custom-scrollbar">
                
                <!-- CÓDIGO PARA MOSTRAR LA IMAGEN "carta2.jpg" -->
                <img src="carta2.jpg" alt="Segunda Carta de mi Reina" class="w-full h-auto rounded-lg">
                <p class="text-right mt-6 font-semibold">- Siempre tuya</p>

            </div>
        </div>
    </div>

    <!-- Modal 3: Estudio Fotográfico IA -->
    <div id="aiModal" style="display: none;" class="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4">
        <!-- Contenedor del Modal -->
        <div class="bg-white rounded-2xl p-6 max-w-lg w-full shadow-2xl relative">
            <!-- Botón de Cerrar -->
            <button id="closeAiModal" class="absolute top-3 right-3 text-gray-500 hover:text-gray-900 text-2xl">&times;</button>
            
            <h3 class="text-3xl font-bold text-rose-title mb-4 font-parisienne text-center">Estudio Fotográfico IA</h3>
            
            <!-- CONTENEDOR DE ERRORES -->
            <div id="aiErrorMessage" style="display: none;" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg mb-4 text-sm">
                <!-- Los mensajes de error aparecerán aquí -->
            </div>

            <div class="space-y-4">
                <!-- 0. API KEY -->
                <div>
                    <label for="apiKeyInput" class="block text-sm font-medium text-gray-700 mb-1">Tu API Key de Google AI</label>
                    <input type="password" id="apiKeyInput" class="w-full border border-gray-300 p-2 rounded-lg" placeholder="Pega tu API Key de AI Studio aquí">
                    <p class="text-xs text-gray-500 mt-1">Necesaria para que funcione en GitHub. Obtenla en aistudio.google.com</p>
                </div>

                <!-- 1. Upload -->
                <div>
                    <label for="imageUpload" class="file-upload-label">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                        1. Sube una foto
                    </label>
                    <input type="file" id="imageUpload" accept="image/*">
                    
                    <div id="imagePreviewContainer" class="mt-4 border-2 border-dashed border-gray-300 rounded-lg p-4 text-center" style="display: none;">
                        <img id="imagePreview" src="#" alt="Vista previa" class="max-h-48 mx-auto rounded">
                    </div>
                    <div id="imagePreviewPlaceholder" class="mt-4 border-2 border-dashed border-gray-300 rounded-lg p-4 text-center">
                        <span id="imagePreviewText" class="text-gray-400">Vista previa de la imagen</span>
                    </div>
                </div>

                <!-- 2. Prompt -->
                <div>
                    <label for="promptInput" class="block text-sm font-medium text-gray-700 mb-1">2. Describe el cambio</label>
                    <input type="text" id="promptInput" class="w-full border border-gray-300 p-2 rounded-lg" placeholder="Ej: en París, como astronautas, etc.">
                </div>

                <!-- 3. Generate -->
                <button id="generateButton" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg transition duration-300 flex items-center justify-center">
                    <span id="generateButtonText">Generar Magia</span>
                    <svg id="generateSpinner" style="display: none;" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </button>
                
                <!-- 4. Result -->
                <div id="resultContainer" style="display: none;">
                    <h4 class="text-lg font-semibold text-gray-800 mb-2">Resultado:</h4>
                    <div class="border border-gray-300 rounded-lg p-2">
                        <img id="resultImage" src="#" alt="Imagen generada" class="w-full h-auto rounded">
                    </div>
                    <!-- BOTÓN DE DESCARGA -->
                    <a id="downloadButton" href="#" download="foto-generada.png" class="mt-4 inline-flex items-center justify-center w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L10 11.586l2.293-2.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v6a1 1 0 11-2 0V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                        Descargar Foto
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- El SCRIPT debe ir al final del BODY -->
    <script>
        // SCRIPT MODIFICADO PARA ROBUSTEZ Y DEBUGGING
        document.addEventListener('DOMContentLoaded', () => {
            console.log("Script cargado. Buscando elementos...");

            // --- Función genérica para Modales ---
            function setupModal(openBtnId, closeBtnId, modalId, modalName) {
                const openBtn = document.getElementById(openBtnId);
                const closeBtn = document.getElementById(closeBtnId);
                const modal = document.getElementById(modalId);

                if (openBtn && closeBtn && modal) {
                    console.log(`Elementos del ${modalName} encontrados.`);
                    openBtn.addEventListener('click', () => {
                        console.log(`Botón '${openBtnId}' presionado. Intentando mostrar ${modalId}.`);
                        modal.style.display = 'flex'; // Usar style.display
                    });
                    closeBtn.addEventListener('click', () => {
                        modal.style.display = 'none'; // Usar style.display
                    });
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) modal.style.display = 'none'; // Usar style.display
                    });
                } else {
                    console.warn(`No se encontraron todos los elementos para el ${modalName}.`);
                    if (!openBtn) console.error(`Falta el botón: ${openBtnId}`);
                    if (!closeBtn) console.error(`Falta el botón: ${closeBtnId}`);
                    if (!modal) console.error(`Falta el modal: ${modalId}`);
                }
            }

            // --- Configurar los tres modales ---
            setupModal('openLetterModal', 'closeLetterModal', 'letterModal', 'Modal 1 (Carta 1)');
            setupModal('openLetterModal2', 'closeLetterModal2', 'letterModal2', 'Modal 2 (Carta 2)');
            setupModal('openAiModal', 'closeAiModal', 'aiModal', 'Modal 3 (IA)');


            // --- Lógica específica del Modal de IA ---
            const aiModal = document.getElementById('aiModal');
            if (aiModal) {
                const apiKeyInput = document.getElementById('apiKeyInput'); 
                const aiErrorMessage = document.getElementById('aiErrorMessage');
                const imageUpload = document.getElementById('imageUpload');
                const imagePreviewContainer = document.getElementById('imagePreviewContainer');
                const imagePreviewPlaceholder = document.getElementById('imagePreviewPlaceholder');
                const imagePreview = document.getElementById('imagePreview');
                const promptInput = document.getElementById('promptInput');
                const generateButton = document.getElementById('generateButton');
                const generateButtonText = document.getElementById('generateButtonText');
                const generateSpinner = document.getElementById('generateSpinner');
                const resultContainer = document.getElementById('resultContainer');
                const resultImage = document.getElementById('resultImage');
                const downloadButton = document.getElementById('downloadButton'); // Botón de descarga

                let base64ImageData = null;
                let originalMimeType = "image/png"; // Default

                // Función para mostrar errores en el modal
                function showAiError(message) {
                    aiErrorMessage.textContent = message;
                    aiErrorMessage.style.display = 'block';
                }
                
                // Limpiar error al cerrar
                document.getElementById('closeAiModal').addEventListener('click', () => {
                    aiErrorMessage.style.display = 'none';
                });

                // Manejar subida de imagen y vista previa
                imageUpload.addEventListener('change', (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        originalMimeType = file.type; // Guardar el tipo de imagen (jpeg, png, etc.)
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            imagePreview.src = e.target.result;
                            imagePreviewContainer.style.display = 'block';
                            imagePreviewPlaceholder.style.display = 'none';
                            
                            // Guardar solo la data base64
                            base64ImageData = e.target.result.split(',')[1];
                        };
                        reader.readAsDataURL(file);
                    }
                });

                // Manejar clic en botón "Generar"
                generateButton.addEventListener('click', async () => {
                    // Limpiar errores previos
                    aiErrorMessage.style.display = 'none';

                    const apiKey = apiKeyInput.value; 
                    const userPrompt = promptInput.value;

                    if (!apiKey) {
                        showAiError("Por favor, ingresa tu API Key de Google AI Studio.");
                        return;
                    }
                    if (!base64ImageData) {
                        showAiError("Por favor, sube una foto primero.");
                        return;
                    }
                    if (!userPrompt) {
                        showAiError("Por favor, escribe una descripción.");
                        return;
                    }

                    // Mostrar estado de carga
                    generateButtonText.textContent = "Generando...";
                    generateSpinner.style.display = 'inline-block';
                    generateButton.disabled = true;
                    resultContainer.style.display = 'none';

                    try {
                        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`;

                        const payload = {
                            contents: [{
                                parts: [
                                    { text: `Edita esta foto: ${userPrompt}` },
                                    { inlineData: { mimeType: originalMimeType, data: base64ImageData } }
                                ]
                            }],
                            generationConfig: {
                                responseModalities: ['IMAGE']
                            },
                        };
                        
                        // Implementar reintento exponencial simple
                        let response;
                        let attempts = 0;
                        const maxAttempts = 5;
                        let delay = 1000; // 1 segundo

                        while (attempts < maxAttempts) {
                            try {
                                response = await fetch(apiUrl, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify(payload)
                                });

                                if (response.status === 429) { // Error de cuota (Too Many Requests)
                                    throw new Error("429");
                                }
                                
                                if (!response.ok) {
                                    const errorData = await response.json();
                                    console.error("Error de API:", errorData);
                                    throw new Error(`Error de la API: ${errorData.error.message}`);
                                }

                                break; // Éxito, salir del bucle
                                
                            } catch (error) {
                                if (error.message === "429" && attempts < maxAttempts - 1) {
                                    console.warn(`Intento ${attempts + 1} fallido (429). Reintentando en ${delay / 1000}s...`);
                                    await new Promise(resolve => setTimeout(resolve, delay));
                                    delay *= 2; // Duplicar el retraso
                                    attempts++;
                                } else {
                                    throw error; // Lanzar el error si no es 429 o si se superan los intentos
                                }
                            }
                        }


                        const result = await response.json();
                        const part = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData);
                        const base64Data = part?.inlineData?.data;

                        if (base64Data) {
                            const imageUrl = `data:image/png;base64,${base64Data}`;
                            resultImage.src = imageUrl;
                            downloadButton.href = imageUrl; // Asignar la URL al botón de descarga
                            resultContainer.style.display = 'block';
                        } else {
                            console.error("No se encontró data de imagen en la respuesta:", result);
                            showAiError("Respuesta de IA exitosa, pero no se encontró la imagen. Revisa la consola.");
                        }

                    } catch (error) {
                        console.error("Error al generar imagen:", error);
                        showAiError(`Error al contactar la API de IA: ${error.message}`);
                    } finally {
                        // Restablecer estado del botón
                        generateButtonText.textContent = "Generar Magia";
                        generateSpinner.style.display = 'none';
                        generateButton.disabled = false;
                    }
                });
            } else {
                console.error("No se encontraron los elementos del Modal de IA.");
            }
        });
    </script>

</body>
</html>

